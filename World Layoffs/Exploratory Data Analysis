-- SQL Project- World Layoffs 
-- https://www.kaggle.com/datasets/swaptr/layoffs-2022

#Exploratory Data Analysis
#1. Companies that completely went under
#2.
#2. Company with layoffs
#3. Layoffs by date
#4. total layoffs by year
#5. Rolling Sum
#6. Company layoffs per year
#7. Rank which years they laid off most employees
#8. Filter the rankings by the top five per year
#9. Find the max total layoffs at one time
#10.Find the largest insdustry with the largest total layoffs
#11.The second largest industry with layoffs
#12.The top 5 industries in each country with layoff

select * 
from layoffs2;

select max(total_laid_off), max(percentage_laid_off)
from layoffs2;

#1. Comapnies that completly went under
select * 
from layoffs2
Where percentage_laid_off = 1
order by funds_raised_millions desc
;

select industry, sum(total_laid_off)
from layoffs2
group by country, industry
order by 2 desc
;

#2. Dates when layoffs started
select min(date), max(date)
from layoffs2;


#3. Layoffs by date
select `date`, sum(total_laid_off)
from layoffs2
group by `date`
order by 1 desc
;

#4. total layoffs by year
select YEAR(`date`), sum(total_laid_off)
from layoffs2
group by YEAR(`date`)
order by 1 desc
;

select company, sum(total_laid_off)
from layoffs2
group by company
order by 2 desc
;

#5. Rolling Sum
#Rolling Sum
#Rolling total layoffs based off month
select substring(`date`,1,7) as `MONTH`,
sum(total_laid_off)
from layoffs2
Where substring(`date`,1,7) is not NULL
group by `MONTH`
Order by 1 ASC
;

WITH Rolling_Total_CTE AS
(select substring(`date`,1,7) as `MONTH`,
sum(total_laid_off) as total_off
from layoffs2
Where substring(`date`,1,7) is not NULL
group by `MONTH`
Order by 1 ASC
)
select `MONTH`, total_off,
sum(total_off)
Over(order by `MONTH`) as rolling_total
from Rolling_Total_CTE;


#6. Company layoffs per year
select company, 
substring(`date`,1,4) as `YEAR`,
sum(total_laid_off) as total_off
from layoffs2
group by company, `YEAR`
order by 1 asc
;

#7. Rank which years they laid off most employees
WITH company_year_cte as
(
select company, 
substring(`date`,1,4) as `YEAR`,
sum(total_laid_off) as total_off
from layoffs2
group by company, `YEAR`
)
select * ,
dense_rank()over(partition by `YEAR` order by total_off desc) as ranking
from company_year_cte 
where `YEAR` is not NULL
order by ranking asc
;

#8. Filter the rankings by the top five per year
#Uses 2 CTEs and dense_rank
WITH company_year_cte as
(
select company, 
substring(`date`,1,4) as `YEAR`,
sum(total_laid_off) as total_off
from layoffs2
group by company, `YEAR`
), 
company_year_rank_cte as 
(select * ,
dense_rank()over(partition by `YEAR` order by total_off desc) as ranking
from company_year_cte 
where `YEAR` is not NULL

)
select * 
from company_year_rank_cte
where ranking <= 5
;

#9. Find the max total layoffs at one time
#10. Find the largest insdustry with the largest total layoffs
#11. The second largest industry with layoffs
#12. The top 5 industries in each country with layoff


select *
from layoffs2
;
#9. Find the company with the max total layoffs at one time
select industry, company,
max(total_laid_off)
from layoffs2
where total_laid_off = (select max(total_laid_off) from layoffs2) 
group by industry, company
;

#10.Find the largest insdustry with the largest total layoffs
select industry, company,
sum(total_laid_off) as tot_laid_off
from layoffs2
group by industry, company
order by tot_laid_off desc
limit 1
;

#11.The second largest industry with layoffs
select industry, company,
sum(total_laid_off) as tot_laid_off
from layoffs2
where total_laid_off < (select max(total_laid_off) from layoffs2) #subquery
group by industry, company
order by tot_laid_off desc
limit 1
;

#12.The top 5 industries in each country with layoff

WITH IndustryLayoffTotals_cte AS (
    -- First, calculate the total number of layoffs for each industry within each country.
    SELECT
        country,
        industry,
        SUM(total_laid_off) AS total_industry_layoffs
    FROM
        layoffs2
    GROUP BY
        country, industry
),
RankedIndustries_cte AS (
    -- Next, rank the industries within each country based on their total layoffs.
    SELECT
        country,
        industry,
        total_industry_layoffs,
        -- RANK() handles ties by giving the same rank. Use ROW_NUMBER() if you want a unique rank for each row.
        RANK() OVER(PARTITION BY country ORDER BY total_industry_layoffs DESC) AS rank_num
    FROM
        IndustryLayoffTotals_cte
)
-- Finally, select the top 5 top-ranked industry for each country.
SELECT
    country,
    industry,
    total_industry_layoffs,
    rank_num
FROM
    RankedIndustries_cte
WHERE
    rank_num < 6
ORDER BY
    country, total_industry_layoffs DESC;





